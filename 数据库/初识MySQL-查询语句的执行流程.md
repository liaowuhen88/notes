## MySQL的基础架构
* 我们通过一条查询语句来看看MySQL是如何执行的，同时通过这条语句的执行，了解MySQL的整体架构体系。
```
mysql> select * from T where ID=1；
```

这是一条非常简单的语句，我们知道输入一条语句，返回一个结果，却不知道这条语句在MySQL内部的执行过程。

下图是MySQL的基本架构图：（大体来说，MySQL可以分为Server层和存储引擎层两部分。）

![Image text](img/1587699874.jpg)

架构示意图，可以理解出SQL语句在MySQL的各个功能模块中的执行过程。

### Server层：

  包括连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，
  以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，
  比如存储过程、触发器、视图等（不同的存储引擎共用一个Server层）。
  
### 存储引擎层：

 * 1.负责数据的存储和提取。其架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎。现在最常用的存储引擎是InnoDB，它从MySQL 5.5.5版本开始成为了默认存储引擎。

 * 2.执行create table建表的时候，如果不指定引擎类型，默认使用的就是InnoDB)。

 * 3.在create table语句中使用engine=memory, 来指定使用内存引擎创建表。不同存储引擎的表数据存取方式不同，支持的功能也不同。

### 一 连接器

连接器负责跟客户端建立连接、获取权限、维持和管理连接。操作数据库第一步需要连接到目标数据库上，所以首先和你打交道的就是连接器。
连接命令一般如下（输入完命令后，提示输入密码。虽然密码也可以直接跟在-p后面写在命令行中，但这样可能会导致你的密码泄露。）：
```
mysql -h$ip -P$port -u$user -p
```

* 1.如果用户名或密码不对，你就会收到一个"Access denied for user"的错误，然后客户端程序结束执行。

* 2.如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。（用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置）**

* 3 连接完成后，可以在show processlist命令中看到它。

 ![Image text](img/1587707521.jpg)

* 4.客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数wait_timeout控制的，默认值是8小时。
   如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒： Lost connection to MySQL server during query。
   这时候如果你要继续，就需要重连，然后再执行请求了。
   
* 5.数据库里面，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。
   建立连接的过程通常是比较复杂的，所以我建议你在使用中要尽量减少建立连接的动作，也就是尽量使用长连接。
   
### 问题1：

全部使用长连接后，有些时候MySQL占用内存涨得特别快，这是因为MySQL在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是MySQL异常重启了
### 解决办法：
* 1.定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。

* 2.如果你用的是MySQL 5.7或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

