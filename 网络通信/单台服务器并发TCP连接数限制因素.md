## 常识一：文件句柄限制

在linux下编写网络服务器程序的朋友肯定都知道每一个tcp连接都要占一个文件描述符，一旦这个文件描述符使用完了，新的连接到来返回给我们的错误是“Socket/File:Can't open so many files”。

这时你需要明白操作系统对可以打开的最大文件数的限制。

### 1进程限制

执行 ulimit -n 输出 1024，说明对于一个进程而言最多只能打开1024个文件，所以你要采用此默认配置最多也就可以并发上千个TCP连接。

#### 临时修改：ulimit -n 1000000，但是这种临时修改只对当前登录用户目前的使用环境有效，系统重启或用户退出后就会失效。

重启后失效的修改（不过我在CentOS 6.5下测试，重启后未发现失效），编辑 /etc/security/limits.conf 文件， 修改后内容为：

* soft nofile 1000000
* hard nofile 1000000

#### 永久修改：编辑/etc/rc.local，在其后添加如下内容：

* ulimit -SHn 1000000

### 2全局限制

执行 cat /proc/sys/fs/file-nr 输出 9344 0 592026，分别为：

* 1. 已经分配的文件句柄数，
* 2. 已经分配但没有使用的文件句柄数，
* 3. 最大文件句柄数。

但在kernel 2.6版本中第二项的值总为0，这并不是一个错误，它实际上意味着已经分配的文件描述符无一浪费的都已经被使用了 。

**我们可以把这个数值改大些，用 root 权限修改 /etc/sysctl.conf 文件:**

* fs.file-max = 1000000
* net.ipv4.ip_conntrack_max = 1000000
* net.ipv4.netfilter.ip_conntrack_max = 1000000
